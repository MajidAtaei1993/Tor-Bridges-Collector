name: Update Tor Bridges

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Create bridges directory
        run: |
          mkdir -p bridges

      - name: Run Scraper
        run: python main.py

      - name: Move files to bridges directory
        run: |
          shopt -s nullglob
          
          for file in *.txt *.json; do
            if [[ "$file" != "README.md" && "$file" != "requirements.txt" ]]; then
              echo "Moving $file to bridges/"
              mv "$file" bridges/
            fi
          done
          
          echo "Checking bridges directory contents:"
          ls -la bridges/
          
          echo "Checking root directory contents:"
          ls -la

      - name: Verify and count bridges
        run: |
          echo "ðŸ“Š Bridge File Statistics:"
          echo "=========================="
          
          total_count=0
          working_count=0
          recent_count=0
          
          for file in bridges/*.txt; do
            if [ -f "$file" ]; then
              count=$(wc -l < "$file" || echo "0")
              filename=$(basename "$file")
              
              if [[ "$filename" == *"_tested.txt" ]]; then
                working_count=$((working_count + count))
                echo "âœ… $filename: $count working bridges"
              elif [[ "$filename" == *"_72h.txt" ]]; then
                recent_count=$((recent_count + count))
                echo "ðŸ†• $filename: $count recent bridges"
              elif [[ "$filename" == *.txt && ! "$filename" == *"_tested.txt" && ! "$filename" == *"_72h.txt" ]]; then
                total_count=$((total_count + count))
                echo "ðŸ“ $filename: $count total bridges"
              fi
            fi
          done
          
          echo "=========================="
          echo "ðŸ“ˆ SUMMARY:"
          echo "Total bridges: $total_count"
          echo "Working bridges: $working_count"
          echo "Recent bridges (72h): $recent_count"
          
          if [ $total_count -gt 0 ]; then
            success_rate=$(echo "scale=2; $working_count * 100 / $total_count" | bc)
            recent_rate=$(echo "scale=2; $recent_count * 100 / $total_count" | bc)
            echo "Success rate: $success_rate%"
            echo "New bridge rate: $recent_rate%"
          fi

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "Checking git status..."
          git status
          
          echo "Adding files..."
          git add bridges/ README.md
          
          echo "Committing changes..."
          timestamp=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "ðŸ“¡ Update bridges - $timestamp [skip ci]" || echo "No changes to commit"
          
          echo "Pushing changes..."
          git push
